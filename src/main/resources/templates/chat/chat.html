<!DOCTYPE html>
<html>
<head>
    <title>ìº¡ìŠ¤í†¤ ì±„íŒ…ë°©</title>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px; }
        .chat-container { max-width: 500px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .chat-header { background: #4a90e2; color: white; padding: 15px; text-align: center; font-weight: bold; }

        /* ì±„íŒ… ë‚´ì—­ ì˜ì—­ */
        #messageArea { height: 400px; overflow-y: scroll; padding: 20px; border-bottom: 1px solid #eee; display: flex; flex-direction: column; gap: 10px; }

        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .message-box { padding: 10px 15px; border-radius: 10px; max-width: 70%; font-size: 14px; }
        .my-msg { background-color: #ffe082; align-self: flex-end; } /* ë‚´ê°€ ì“´ ê¸€ */
        .other-msg { background-color: #e0e0e0; align-self: flex-start; } /* ë‚¨ì´ ì“´ ê¸€ */
        .writer-name { font-size: 11px; color: #555; margin-bottom: 4px; display: block; }

        /* ì…ë ¥ ì˜ì—­ */
        .input-area { padding: 15px; display: flex; gap: 10px; background: #fff; }
        input[type="text"] { padding: 10px; border: 1px solid #ddd; border-radius: 5px; outline: none; }
        #writer { width: 80px; text-align: center; }
        #content { flex-grow: 1; }
        button { padding: 10px 20px; background: #4a90e2; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #357abd; }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="chat-header">ğŸ”¥ ì‹¤ì‹œê°„ ì±„íŒ…ë°© ğŸ”¥</div>

    <div id="messageArea"></div>

    <div class="input-area">
        <input type="text" id="writer" placeholder="ë‹‰ë„¤ì„" />
        <input type="text" id="content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.keyCode==13) sendMessage()" />
        <button onclick="sendMessage()">ì „ì†¡</button>
    </div>
</div>

<script>
    var stompClient = null;
    var currentWriter = ""; // í˜„ì¬ ë‚´ ë‹‰ë„¤ì„ ì €ì¥ìš©

    // 1. í˜ì´ì§€ ì—´ë¦¬ë©´ ë°”ë¡œ ì†Œì¼“ ì—°ê²°
    function connect() {
        var socket = new SockJS('/ws-chat');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // êµ¬ë… ì„¤ì •: ë©”ì‹œì§€ê°€ ì˜¤ë©´ showMessage ì‹¤í–‰
            stompClient.subscribe('/topic/public', function (messageOutput) {
                showMessage(JSON.parse(messageOutput.body));
            });
        });
    }

    // 2. ë©”ì‹œì§€ ì „ì†¡ ê¸°ëŠ¥ (HTML -> Controller -> DB -> Socket)
    function sendMessage() {
        var writerInput = document.getElementById('writer');
        var contentInput = document.getElementById('content');

        var writer = writerInput.value.trim();
        var content = contentInput.value.trim();

        if (!writer || !content) {
            alert("ë‹‰ë„¤ì„ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }

        currentWriter = writer; // ë‚´ ë‹‰ë„¤ì„ ê¸°ì–µ (í™”ë©´ í‘œì‹œìš©)

        // APIë¡œ ì „ì†¡ (Postmanì´ í•˜ë˜ ì¼ì„ ìë°”ìŠ¤í¬ë¦½íŠ¸ê°€ ëŒ€ì‹  í•¨)
        fetch('/api/chat/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                writer: writer,
                content: content
            })
        }).then(() => {
            contentInput.value = ''; // ì „ì†¡ í›„ ì…ë ¥ì°½ ë¹„ìš°ê¸°
            contentInput.focus();
        });
    }

    // 3. í™”ë©´ì— ë©”ì‹œì§€ ê·¸ë¦¬ê¸°
    function showMessage(message) {
        var messageArea = document.getElementById('messageArea');

        var msgDiv = document.createElement('div');
        msgDiv.classList.add('message-box');

        // ë‚´ê°€ ì“´ ê±´ ì˜¤ë¥¸ìª½(ë…¸ë€ìƒ‰), ë‚¨ì´ ì“´ ê±´ ì™¼ìª½(íšŒìƒ‰)
        if (message.writer === currentWriter) {
            msgDiv.classList.add('my-msg');
        } else {
            msgDiv.classList.add('other-msg');
        }

        var nameSpan = document.createElement('span');
        nameSpan.classList.add('writer-name');
        nameSpan.innerText = message.writer;

        var contentSpan = document.createElement('span');
        contentSpan.innerText = message.content;

        msgDiv.appendChild(nameSpan);
        msgDiv.appendChild(contentSpan);
        messageArea.appendChild(msgDiv);

        // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
        messageArea.scrollTop = messageArea.scrollHeight;
    }

    // ì‹œì‘í•˜ìë§ˆì ì—°ê²°
    connect();
</script>

</body>
</html>